<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カメラ切替（個別表示）</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            margin: 0;
            padding: 1em;
        }
        .controls {
            margin-bottom: 1em;
        }
        button {
            font-size: 1.1em;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
        }
        .video-wrapper {
            margin-bottom: 1em;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
        }
        video {
            width: 90%;
            max-width: 400px;
            background-color: #000;
            border-radius: 4px;
        }
        #sensor-data {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            display: inline-block;
        }
    </style>
</head>
<body>

    <h1>カメラ切替（個別表示）</h1>

    <div class="controls">
        <button id="start-button">開始</button>
        <button id="front-cam-button" style="display:none;">インカメラ表示</button>
        <button id="back-cam-button" style="display:none;">アウトカメラ表示</button>
    </div>

    <div class="video-wrapper">
        <h2>インカメラ (うちカメラ)</h2>
        <video id="front-video" playsinline></video>
    </div>

    <div class="video-wrapper">
        <h2>アウトカメラ (そとカメラ)</h2>
        <video id="back-video" playsinline></video>
    </div>

    <div id="sensor-data-container" style="display:none;">
      <div id="sensor-data">
          <h2>ジャイロセンサー情報</h2>
          <p>X軸 (alpha): <span id="alpha">...</span></p>
          <p>Y軸 (beta): <span id="beta">...</span></p>
          <p>Z軸 (gamma): <span id="gamma">...</span></p>
      </div>
    </div>


    <script>
        const startButton = document.getElementById('start-button');
        const frontCamButton = document.getElementById('front-cam-button');
        const backCamButton = document.getElementById('back-cam-button');
        const frontVideo = document.getElementById('front-video');
        const backVideo = document.getElementById('back-video');
        const sensorContainer = document.getElementById('sensor-data-container');

        const alphaSpan = document.getElementById('alpha');
        const betaSpan = document.getElementById('beta');
        const gammaSpan = document.getElementById('gamma');

        let currentStream;

        // 現在のカメラストリームを停止する関数
        function stopCurrentStream() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    track.stop();
                });
            }
            // 両方のビデオ表示をクリア
            frontVideo.srcObject = null;
            backVideo.srcObject = null;
        }

        // 指定されたカメラを起動する関数
        async function startCamera(facingMode) {
            stopCurrentStream(); // まず現在のストリームを停止

            // 表示先のビデオ要素を選択
            const videoElement = (facingMode === 'user') ? frontVideo : backVideo;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode }
                });
                
                videoElement.srcObject = stream;
                await videoElement.play();
                currentStream = stream;

            } catch (err) {
                console.error("カメラの起動に失敗:", err);
                alert(`カメラ(${facingMode})の起動に失敗しました。`);
            }
        }

        // 開始ボタンの処理
        startButton.addEventListener('click', async () => {
            // ① モーションセンサーの許可を求める
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permissionState = await DeviceOrientationEvent.requestPermission();
                    if (permissionState === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                        sensorContainer.style.display = 'block';
                    }
                } catch (error) {
                    console.error("センサー許可エラー:", error);
                }
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
                sensorContainer.style.display = 'block';
            }
            
            // ② 最初はアウトカメラを起動
            await startCamera('environment');

            // ③ ボタンの表示を切り替え
            startButton.style.display = 'none';
            frontCamButton.style.display = 'inline-block';
            backCamButton.style.display = 'inline-block';
        });

        // カメラ切替ボタンのイベント
        frontCamButton.addEventListener('click', () => startCamera('user'));
        backCamButton.addEventListener('click', () => startCamera('environment'));

        // センサー情報を更新
        function handleOrientation(event) {
            alphaSpan.textContent = event.alpha ? event.alpha.toFixed(2) : 'N/A';
            betaSpan.textContent = event.beta ? event.beta.toFixed(2) : 'N/A';
            gammaSpan.textContent = event.gamma ? event.gamma.toFixed(2) : 'N/A';
        }
    </script>

</body>
</html>
